<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オフライン シフト作成アプリ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f4f4f9; color: #333; }
        .container { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        h1, h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        input, select { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        button { font-size: 1em; padding: 10px 18px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        form { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .back-button { background-color: #6c757d; margin-bottom: 20px;}
        .delete-btn { background-color: #dc3545; }
        ul, li { list-style: none; padding: 0; }
        li { background: #fff; padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        li:first-child { border-top: 1px solid #eee; }
        .schedule-timeline-container { border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
        .schedule-timeline { display: flex; flex-direction: column; gap: 5px; }
        .timeline-header, .timeline-row { display: flex; align-items: center; }
        .timeline-label { min-width: 120px; font-weight: bold; font-size: 0.9em; padding-right: 10px; text-align: right; }
        .timeline-slots { flex-grow: 1; position: relative; background: #fafafa; height: 30px; border-left: 1px solid #eee; border-right: 1px solid #eee; min-height: 30px; }
        .employee-bar { position: absolute; height: 25px; color: white; opacity: 0.85; border-radius: 4px; overflow: hidden; white-space: nowrap; font-size: 0.8em; line-height: 25px; padding-left: 5px; box-sizing: border-box; cursor: grab; z-index: 10; }
        .employee-bar.part-time { background-color: #28a745; border: 1px solid #218838; }
        .employee-bar.casual { background-color: #17a2b8; border: 1px solid #138496; }
        .candidate-bar { position: absolute; height: 20px; top: 2px; background-color: #adb5bd; opacity: 0.6; border-radius: 4px; z-index: 5; cursor: pointer; transition: opacity 0.2s; }
        .candidate-bar:hover { opacity: 0.9; border: 1px solid #333; }
        .vacancy-bar { position: absolute; height: 25px; background-color: #dc3545; color: white; opacity: 0.8; border-radius: 4px; overflow: hidden; font-size: 0.8em; line-height: 25px; padding: 0 5px; box-sizing: border-box; text-align: center; z-index: 15; }
        .timeline-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; }
        .grid-line { flex: 1; border-left: 1px dotted #ccc; }
        .time-marker { position: absolute; bottom: -20px; color: #666; font-size: 0.8em;}
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #copy-target-dates, #demand-copy-target-dates { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 15px; margin: 15px 0; }
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
        details { border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; background-color: #f9f9f9; }
        summary { font-weight: bold; padding: 12px; cursor: pointer; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '▶'; margin-right: 8px; display: inline-block; transition: transform 0.2s; }
        details[open] > summary::before { transform: rotate(90deg); }
        .details-content { padding: 0 15px 15px 15px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="copy-modal" class="modal"> <div class="modal-content"> <span class="close-btn" data-modal-id="copy-modal">×</span> <h3>出勤可能時間をコピー</h3> <p><strong>コピー元:</strong> <span id="copy-source-info"></span></p> <p>以下からコピーしたい日付を選択してください。</p> <div id="copy-target-dates"></div> <button id="execute-copy-btn" style="width: 100%; margin-top: 15px;">選択した日付にコピー</button> </div> </div>
    <div id="demand-copy-modal" class="modal"> <div class="modal-content"> <span class="close-btn" data-modal-id="demand-copy-modal">×</span> <h3>必要人数設定をコピー</h3> <p><strong>コピー元:</strong> <span id="demand-copy-source-info"></span></p> <p>以下からコピーしたい日付を選択してください。</p> <div id="demand-copy-target-dates"></div> <button id="execute-demand-copy-btn" style="width: 100%; margin-top: 15px;">選択した日付にコピー</button> </div> </div>
    <div id="mode-selection-view" class="container"> <h1>利用モードを選択してください</h1> <button id="admin-mode-btn" class="mode-button">管理者として利用</button> <button id="employee-mode-btn" class="mode-button">従業員として利用</button> </div>
    <div id="employee-selection-view" class="container hidden"> <button class="back-button">← モード選択に戻る</button> <h2>あなたは誰ですか？</h2> <select id="employee-selector" style="width: 100%; font-size: 1.1em; padding: 10px; margin-bottom: 10px;"></select> <button id="select-employee-btn" style="width: 100%;" disabled>決定</button> </div>
    <div id="app-view" class="container hidden">
        <button class="back-button">← モード選択に戻る</button> <h1 id="app-title">シフト管理</h1>
        <section id="demand-section"> <h2>必要人数の設定 (Demand)</h2> <form id="demand-form"> <input type="date" id="demand-date" required> <select id="demand-start-time"></select> ～ <select id="demand-end-time"></select> <input type="number" id="demand-people" placeholder="必要人数" min="1" required style="width:100px;"> <select id="demand-priority-type"> <option value="any">どちらでも</option> <option value="part-time">パート優先</option> <option value="casual">バイト優先</option> </select> <button type="submit">設定</button> </form> <button type="button" id="open-demand-copy-modal-btn" style="margin-top:10px;">この日の設定をコピー</button> <p>設定済みリスト (日付を選択すると表示):</p> <div id="demand-list"></div> </section>
        <section id="employee-management-section"> <h2>従業員管理</h2> <form id="employee-form"> <input type="text" id="employee-name" placeholder="従業員名" required> <select id="employee-type"> <option value="part-time">パート</option> <option value="casual">バイト</option> </select> <input type="number" id="contract-days" placeholder="週の契約日数" min="1" max="7" required style="width:120px;"> <button type="submit">従業員を追加</button> </form> <ul id="employee-list"></ul> </section>
        <section> <h2>出勤可能時間の登録 (Availability)</h2> <form id="availability-form"> <select id="availability-employee" required></select> <input type="date" id="availability-date" required> <select id="availability-start-time"></select> ～ <select id="availability-end-time"></select> <button type="submit">登録</button> <button type="button" id="open-copy-modal-btn">他の日にコピー</button> </form> <p>登録済みの出勤可能時間:</p> <div id="availability-list"></div> </section>
        <section id="generation-section"> <h2>シフト自動生成</h2> <form id="generation-form"> <select id="generate-year"></select> 年 <select id="generate-month"></select> 月 <select id="generate-period"> <option value="1">前半 (1日～15日)</option> <option value="2">後半 (16日～末日)</option> </select> <button type="submit">シフトを生成</button> </form> </section>
        <section> <h2 id="schedule-title">シフト表</h2> <div id="schedule-selector-container" style="display:flex; align-items:center; gap:10px;"> <select id="schedule-year"></select> 年 <select id="schedule-month"></select> 月 <select id="schedule-period"> <option value="1">前半 (1日～15日)</option> <option value="2">後半 (16日～末日)</option> </select> </div> <div id="schedule-table-container"></div> <div id="stats-container"></div> </section>
    </div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
<script>
"use strict";

document.addEventListener('DOMContentLoaded', () => {
    // PWA Service Worker登録
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.error('SW registration failed:', err)); }); }

    // DB設定
    const db = new Dexie('ShiftAppDB');
    db.version(9).stores({ demands: '++id, date', availabilities: '++id, &[employeeId+date], date', employees: '++id, name', schedules: 'id, date' });

    // グローバル変数
    let currentUserMode = null, currentEmployeeId = null;

    // DOM要素
    const dom = {
        modeSelectionView: document.getElementById('mode-selection-view'), employeeSelectionView: document.getElementById('employee-selection-view'), appView: document.getElementById('app-view'),
        adminModeBtn: document.getElementById('admin-mode-btn'), employeeModeBtn: document.getElementById('employee-mode-btn'),
        employeeSelector: document.getElementById('employee-selector'), selectEmployeeBtn: document.getElementById('select-employee-btn'),
        appTitle: document.getElementById('app-title'), demandSection: document.getElementById('demand-section'), demandForm: document.getElementById('demand-form'), demandDateInput: document.getElementById('demand-date'), demandStartTimeSelect: document.getElementById('demand-start-time'), demandEndTimeSelect: document.getElementById('demand-end-time'), demandPeopleInput: document.getElementById('demand-people'), demandPriorityTypeSelect: document.getElementById('demand-priority-type'), demandList: document.getElementById('demand-list'), openDemandCopyModalBtn: document.getElementById('open-demand-copy-modal-btn'),
        employeeManagementSection: document.getElementById('employee-management-section'), employeeForm: document.getElementById('employee-form'), employeeNameInput: document.getElementById('employee-name'), employeeTypeSelect: document.getElementById('employee-type'), contractDaysInput: document.getElementById('contract-days'), employeeList: document.getElementById('employee-list'),
        availabilityForm: document.getElementById('availability-form'), availabilityEmployeeSelect: document.getElementById('availability-employee'), availabilityDateInput: document.getElementById('availability-date'), availabilityStartTimeSelect: document.getElementById('availability-start-time'), availabilityEndTimeSelect: document.getElementById('availability-end-time'), availabilityList: document.getElementById('availability-list'),
        generationSection: document.getElementById('generation-section'), generationForm: document.getElementById('generation-form'), generateYearSelect: document.getElementById('generate-year'), generateMonthSelect: document.getElementById('generate-month'), generatePeriodSelect: document.getElementById('generate-period'),
        scheduleSelectorContainer: document.getElementById('schedule-selector-container'), scheduleYearSelect: document.getElementById('schedule-year'), scheduleMonthSelect: document.getElementById('schedule-month'), schedulePeriodSelect: document.getElementById('schedule-period'),
        scheduleTableContainer: document.getElementById('schedule-table-container'), statsContainer: document.getElementById('stats-container'),
        copyModal: document.getElementById('copy-modal'), openCopyModalBtn: document.getElementById('open-copy-modal-btn'), executeCopyBtn: document.getElementById('execute-copy-btn'), copySourceInfo: document.getElementById('copy-source-info'), copyTargetDatesContainer: document.getElementById('copy-target-dates'),
        demandCopyModal: document.getElementById('demand-copy-modal'), executeDemandCopyBtn: document.getElementById('execute-demand-copy-btn'), demandCopySourceInfo: document.getElementById('demand-copy-source-info'), demandCopyTargetDatesContainer: document.getElementById('demand-copy-target-dates'),
        backButtons: document.querySelectorAll('.back-button')
    };

    // ヘルパー関数
    const timeToMinutes = (time) => { if (!time) return 0; const [h, m] = time.split(':').map(Number); return h * 60 + m; };
    const getDayRange = (year, month, period) => { const startDay = (period === 1) ? 1 : 16; const endDay = (period === 1) ? 15 : new Date(year, month, 0).getDate(); return { startDay, endDay }; };
    
    // 描画関数
    const populateTimeSelects = () => { const selects = [dom.demandStartTimeSelect, dom.demandEndTimeSelect, dom.availabilityStartTimeSelect, dom.availabilityEndTimeSelect]; let options = ''; for (let h = 0; h < 24; h++) for (let m = 0; m < 60; m += 30) { const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; options += `<option value="${time}">${time}</option>`; } selects.forEach(select => select.innerHTML = options); };
    const populateYearMonthSelects = () => { const today = new Date(), currentYear = today.getFullYear(), currentMonth = today.getMonth() + 1; const yearSelects = [dom.generateYearSelect, dom.scheduleYearSelect], monthSelects = [dom.generateMonthSelect, dom.scheduleMonthSelect]; let yearOptions = ''; for (let y = currentYear - 2; y <= currentYear + 2; y++) yearOptions += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`; yearSelects.forEach(s => s.innerHTML = yearOptions); let monthOptions = ''; for (let m = 1; m <= 12; m++) monthOptions += `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}</option>`; monthSelects.forEach(s => s.innerHTML = monthOptions); };

    // ビュー管理
    const showView = (viewName) => { const views = {modeSelection: dom.modeSelectionView, employeeSelection: dom.employeeSelectionView, app: dom.appView}; Object.values(views).forEach(view => view.classList.add('hidden')); if(views[viewName]) views[viewName].classList.remove('hidden'); };
    const showModeSelectionView = () => { currentUserMode = null; currentEmployeeId = null; showView('modeSelection'); };
    const setupAdminMode = async () => { currentUserMode = 'admin'; dom.appTitle.textContent = 'シフト管理 (管理者)'; dom.demandSection.classList.remove('hidden'); dom.employeeManagementSection.classList.remove('hidden'); dom.generationSection.classList.remove('hidden'); dom.availabilityEmployeeSelect.disabled = false; await renderAll(); showView('app'); };
    const showEmployeeSelection = async () => { const employees = await db.employees.toArray(); if (employees.length === 0) { alert('従業員が登録されていません。'); return; } await populateEmployeeSelector(); showView('employeeSelection'); };
    const setupEmployeeMode = async (employeeId) => { currentUserMode = 'employee'; currentEmployeeId = employeeId; const employee = await db.employees.get(employeeId); dom.appTitle.textContent = `ようこそ、${employee.name}さん`; dom.demandSection.classList.add('hidden'); dom.employeeManagementSection.classList.add('hidden'); dom.generationSection.classList.add('hidden'); dom.availabilityEmployeeSelect.innerHTML = `<option value="${employee.id}">${employee.name}</option>`; dom.availabilityEmployeeSelect.disabled = true; await renderAll(); showView('app'); };
    const populateEmployeeSelector = async () => { const employees = await db.employees.toArray(); dom.employeeSelector.innerHTML = '<option value="">名前を選択してください</option>'; employees.forEach(emp => { dom.employeeSelector.innerHTML += `<option value="${emp.id}">${emp.name}</option>`; }); dom.selectEmployeeBtn.disabled = true; };

    // データ描画
    const renderAll = async () => { try { if (currentUserMode === 'admin') { await renderEmployees(); await populateAvailabilityEmployeeSelect(); } await renderAvailabilities(); await renderScheduleForPeriod(); } catch (err) { console.error("Render All failed:", err); }};
    const renderEmployees = async () => { const employees = await db.employees.toArray(); dom.employeeList.innerHTML = ''; employees.forEach(emp => { const typeText = emp.type === 'part-time' ? 'パート' : 'バイト'; const li = document.createElement('li'); li.innerHTML = `<span>${emp.name} (${typeText}, 週${emp.contractDays}日)</span>`; const deleteBtn = document.createElement('button'); deleteBtn.textContent = '削除'; deleteBtn.className = 'delete-btn'; deleteBtn.onclick = () => deleteEmployee(emp.id); li.appendChild(deleteBtn); dom.employeeList.appendChild(li); }); };
    const populateAvailabilityEmployeeSelect = async () => { const employees = await db.employees.toArray(); dom.availabilityEmployeeSelect.innerHTML = ''; employees.forEach(emp => { const option = document.createElement('option'); option.value = emp.id; option.textContent = emp.name; dom.availabilityEmployeeSelect.appendChild(option); }); };
    const renderAvailabilities = async () => { let query = db.availabilities; if (currentUserMode === 'employee') query = query.where('employeeId').equals(currentEmployeeId); const allAvails = await query.toArray(); dom.availabilityList.innerHTML = ''; const today = new Date(); today.setHours(0, 0, 0, 0); const futureAvails = allAvails.filter(a => new Date(a.date) >= today); if (futureAvails.length === 0) { dom.availabilityList.innerHTML = '<p>登録済みの出勤可能時間（本日以降）はありません。</p>'; return; } const employeeMap = new Map((await db.employees.toArray()).map(e => [e.id, e.name])); const groupedByMonth = futureAvails.reduce((acc, curr) => { const monthKey = curr.date.substring(0, 7); if (!acc[monthKey]) acc[monthKey] = {}; if (!acc[monthKey][curr.date]) acc[monthKey][curr.date] = []; acc[monthKey][curr.date].push(curr); return acc; }, {}); const sortedMonths = Object.keys(groupedByMonth).sort(); for (const monthKey of sortedMonths) { const dailyData = groupedByMonth[monthKey]; const [year, month] = monthKey.split('-'); const monthObj = new Date(year, month - 1, 1); const formattedMonth = `${monthObj.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' })}`; let dailyDetailsHTML = ''; const sortedDays = Object.keys(dailyData).sort(); for (const date of sortedDays) { const items = dailyData[date]; const dateObj = new Date(date + 'T00:00:00'); const formattedDate = `${dateObj.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'short' })}`; let listItemsHTML = ''; for (const item of items) { const empName = employeeMap.get(item.employeeId); if (empName) { listItemsHTML += `<li data-id="${item.id}"><span>${empName} (${item.startTime} - ${item.endTime})</span><button class="delete-btn" data-id="${item.id}">削除</button></li>`; } } dailyDetailsHTML += `<details><summary>${formattedDate} - ${items.length}件</summary><div class="details-content"><ul>${listItemsHTML}</ul></div></details>`; } const monthDetails = document.createElement('details'); if (sortedMonths.indexOf(monthKey) === 0) monthDetails.open = true; monthDetails.innerHTML = `<summary style="background-color: #e9ecef;">${formattedMonth}</summary><div class="details-content" style="padding-left: 20px;">${dailyDetailsHTML}</div>`; dom.availabilityList.appendChild(monthDetails); } dom.availabilityList.querySelectorAll('.delete-btn').forEach(btn => { btn.onclick = () => deleteAvailability(parseInt(btn.dataset.id)); }); };
    const renderDemandsForDate = async (date) => { if (!date) { dom.demandList.innerHTML = ''; return; } const demands = await db.demands.where('date').equals(date).sortBy('startTime'); dom.demandList.innerHTML = ''; if (demands.length === 0) { dom.demandList.innerHTML = '<p>この日の設定はありません。</p>'; return; } const priorityMap = { any: 'どちらでも', 'part-time': 'パート優先', 'casual': 'バイト優先' }; let listItemsHTML = ''; for (const d of demands) { listItemsHTML += `<li data-id="${d.id}"><span>${d.startTime} - ${d.endTime}: ${d.people}人 (${priorityMap[d.priorityType]})</span><button class="delete-btn" data-id="${d.id}">削除</button></li>`; } dom.demandList.innerHTML = `<ul>${listItemsHTML}</ul>`; dom.demandList.querySelectorAll('.delete-btn').forEach(btn => { btn.onclick = () => deleteDemand(parseInt(btn.dataset.id), date); }); };
    
    // データ操作
    const addDemand = async (e) => { e.preventDefault(); const date = dom.demandDateInput.value, startTime = dom.demandStartTimeSelect.value, endTime = dom.demandEndTimeSelect.value, people = parseInt(dom.demandPeopleInput.value, 10), priorityType = dom.demandPriorityTypeSelect.value; if (date && startTime < endTime && people > 0) { await db.demands.add({ date, startTime, endTime, people, priorityType }); await renderDemandsForDate(date); } else { alert('入力が正しくありません。'); } };
    const addEmployee = async (e) => { e.preventDefault(); const name = dom.employeeNameInput.value.trim(), type = dom.employeeTypeSelect.value, contractDays = parseInt(dom.contractDaysInput.value, 10); if (name && type && contractDays > 0) { await db.employees.add({ name, type, contractDays }); dom.employeeForm.reset(); await renderAll(); } };
    const deleteEmployee = async (id) => { if (confirm('この従業員を削除しますか？')) { await db.transaction('rw', db.employees, db.availabilities, db.demands, async () => { await db.employees.delete(id); await db.availabilities.where('employeeId').equals(id).delete(); }); await renderAll(); } };
    const addAvailability = async (e) => { e.preventDefault(); const employeeId = parseInt(dom.availabilityEmployeeSelect.value, 10), date = dom.availabilityDateInput.value, startTime = dom.availabilityStartTimeSelect.value, endTime = dom.availabilityEndTimeSelect.value; if (employeeId && date && startTime < endTime) { await db.availabilities.put({ employeeId, date, startTime, endTime }); await renderAvailabilities(); } else { alert('入力が正しくありません。'); } };
    const deleteDemand = async (id, date) => { if (confirm('この必要人数設定を削除しますか？')) { await db.demands.delete(id); await renderDemandsForDate(date); } };
    const deleteAvailability = async (id) => { if (confirm('この出勤可能時間を削除しますか？')) { await db.availabilities.delete(id); await renderAvailabilities(); } };
    
    // コピー機能
    const openAvailabilityCopyModal = () => { const dateStr = dom.availabilityDateInput.value; const startTime = dom.availabilityStartTimeSelect.value; const endTime = dom.availabilityEndTimeSelect.value; if (!dateStr || startTime >= endTime) { return alert('コピー元の有効な日付と時間を入力してください。'); } dom.copySourceInfo.textContent = `${dateStr} の ${startTime}～${endTime}`; const dateObj = new Date(dateStr + 'T00:00:00'); const year = dateObj.getFullYear(), month = dateObj.getMonth() + 1, day = dateObj.getDate(); const period = (day <= 15) ? 1 : 2; const { startDay, endDay } = getDayRange(year, month, period); dom.copyTargetDatesContainer.innerHTML = ''; for (let d = startDay; d <= endDay; d++) { const currentDateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`; if (currentDateStr === dateStr) continue; const dObj = new Date(currentDateStr + 'T00:00:00'); const formattedDate = `${dObj.getMonth() + 1}月${dObj.getDate()}日(${['日', '月', '火', '水', '木', '金', '土'][dObj.getDay()]})`; dom.copyTargetDatesContainer.innerHTML += `<label><input type="checkbox" class="date-check" value="${currentDateStr}">${formattedDate}</label>`; } dom.copyModal.style.display = 'flex'; };
    const openDemandCopyModal = () => { const dateStr = dom.demandDateInput.value; if (!dateStr) { return alert('コピー元の日付を選択してください。'); } dom.demandCopySourceInfo.textContent = `${dateStr} の設定`; const dateObj = new Date(dateStr + 'T00:00:00'); const year = dateObj.getFullYear(), month = dateObj.getMonth() + 1, day = dateObj.getDate(); const period = (day <= 15) ? 1 : 2; const { startDay, endDay } = getDayRange(year, month, period); dom.demandCopyTargetDatesContainer.innerHTML = ''; for (let d = startDay; d <= endDay; d++) { const currentDateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`; if (currentDateStr === dateStr) continue; const dObj = new Date(currentDateStr + 'T00:00:00'); const formattedDate = `${dObj.getMonth() + 1}月${dObj.getDate()}日(${['日', '月', '火', '水', '木', '金', '土'][dObj.getDay()]})`; dom.demandCopyTargetDatesContainer.innerHTML += `<label><input type="checkbox" class="date-check" value="${currentDateStr}">${formattedDate}</label>`; } dom.demandCopyModal.style.display = 'flex'; };
    const closeCopyModal = (type) => { const modal = (type === 'demand') ? dom.demandCopyModal : dom.copyModal; if (modal) modal.style.display = 'none'; };
    const executeCopy = async () => { const employeeId = parseInt(dom.availabilityEmployeeSelect.value, 10), startTime = dom.availabilityStartTimeSelect.value, endTime = dom.availabilityEndTimeSelect.value; const checkedDates = Array.from(dom.copyModal.querySelectorAll('.date-check:checked')).map(cb => cb.value); if (!employeeId || checkedDates.length === 0) return alert('従業員・コピー先が選択されていません。'); const availabilitiesToPut = checkedDates.map(date => ({ employeeId, date, startTime, endTime })); try { await db.availabilities.bulkPut(availabilitiesToPut); alert(`${availabilitiesToPut.length}件コピーしました。`); await renderAvailabilities(); closeCopyModal('availability'); } catch (error) { alert('コピー中にエラー: ' + error); } };
    const executeDemandCopy = async () => { const sourceDate = dom.demandDateInput.value; const targetDates = Array.from(dom.demandCopyModal.querySelectorAll('.date-check:checked')).map(cb => cb.value); if (!sourceDate || targetDates.length === 0) return alert('コピー元・先の情報が不足しています。'); const sourceDemands = await db.demands.where('date').equals(sourceDate).toArray(); if (sourceDemands.length === 0) return alert('コピー元の日に設定がありません。'); const demandsToPut = []; for (const date of targetDates) { for (const demand of sourceDemands) { const {id, ...rest} = demand; demandsToPut.push({ ...rest, date: date }); } } try { await db.demands.bulkPut(demandsToPut); alert(`${targetDates.length}日分、合計${demandsToPut.length}件の設定をコピーしました。`); await renderDemandsForDate(dom.demandDateInput.value); closeCopyModal('demand'); } catch (error) { alert('コピー中にエラー: ' + error); } };
    
    // コスト計算
    const calculateAssignmentCost = (stats, block, allStats) => { let cost = 0; if (stats.assignedMinutes + block.duration > stats.maxMinutes) return Infinity; const targetRatio = stats.targetMinutes > 0 ? stats.assignedMinutes / stats.targetMinutes : 1; cost += (targetRatio < 1) ? (targetRatio - 1) * 100 : (targetRatio - 1) * 500; let totalMinutes = 0, numEmployees = 0; allStats.forEach(s => { totalMinutes += s.assignedMinutes; numEmployees++; }); const averageMinutes = numEmployees > 0 ? totalMinutes / numEmployees : 0; cost += (stats.assignedMinutes - averageMinutes) / 60; if (block.priorityType !== 'any') { if (stats.type === block.priorityType) { cost -= 50; } else { cost += 50; } } return cost; };
    
    // ★★★ シフト生成ロジックを修正 ★★★
    const handleGenerateSchedule = async (e) => { e.preventDefault(); try { const year = parseInt(dom.generateYearSelect.value), month = parseInt(dom.generateMonthSelect.value), period = parseInt(dom.generatePeriodSelect.value); const { startDay, endDay } = getDayRange(year, month, period); const startDate = new Date(year, month - 1, startDay), endDate = new Date(year, month - 1, endDay); const [allDemands, allAvailabilities, allEmployees] = await Promise.all([ db.demands.where('date').between(startDate.toISOString().slice(0, 10), endDate.toISOString().slice(0, 10), true, true).toArray(), db.availabilities.where('date').between(startDate.toISOString().slice(0, 10), endDate.toISOString().slice(0, 10), true, true).toArray(), db.employees.toArray() ]); if (allEmployees.length === 0) return alert('従業員を登録してください。'); if (allDemands.length === 0) return alert('対象期間の「必要人数」が設定されていません。'); let shiftBlocks = []; for (const demand of allDemands) { for (let i = 0; i < demand.people; i++) { const block = { id: `block-${demand.id}-${i}`, date: demand.date, start: demand.startTime, end: demand.endTime, duration: timeToMinutes(demand.endTime) - timeToMinutes(demand.startTime), priorityType: demand.priorityType, assignedTo: null, candidates: [] }; const candidateStats = allAvailabilities.filter(avail => avail.date === block.date && avail.startTime <= block.start && avail.endTime >= block.end).map(avail => allEmployees.find(e => e.id === avail.employeeId)).filter(stats => stats); block.candidates = candidateStats.map(s => s.id); shiftBlocks.push(block); } } const weeksInPeriod = (endDay - startDay + 1) / 7; const employeeStats = new Map(allEmployees.map(e => [e.id, { ...e, maxMinutes: 40 * 60 * weeksInPeriod, targetMinutes: e.contractDays * 8 * 60 * weeksInPeriod, assignedMinutes: 0, assignedShifts: [] }])); let unassignedBlocks = [...shiftBlocks]; while (unassignedBlocks.length > 0) { let bestMatch = null, minCost = Infinity; for (const block of unassignedBlocks) { const candidates = block.candidates.map(id => employeeStats.get(id)).filter(stats => { if (!stats) return false; return !stats.assignedShifts.some(assigned => assigned.date === block.date); }); for (const stats of candidates) { const cost = calculateAssignmentCost(stats, block, employeeStats); if (cost < minCost) { minCost = cost; bestMatch = { block, employeeStats: stats }; } } } if (bestMatch) { const { block, employeeStats: stats } = bestMatch; block.assignedTo = stats.id; stats.assignedMinutes += block.duration; stats.assignedShifts.push(block); unassignedBlocks = unassignedBlocks.filter(b => b.id !== block.id); } else { break; } } const dailySchedules = new Map(); for (const block of shiftBlocks) { const date = block.date; if (!dailySchedules.has(date)) dailySchedules.set(date, { id: date, shifts: {}, candidates: {}, vacancies: [] }); const schedule = dailySchedules.get(date); if (block.assignedTo) { const empId = block.assignedTo; if (!schedule.shifts[empId]) schedule.shifts[empId] = []; schedule.shifts[empId].push({ start: block.start, end: block.end }); const otherCandidates = block.candidates.filter(id => id !== empId); if (otherCandidates.length > 0) { const key = `${block.start}-${block.end}`; if (!schedule.candidates[key]) schedule.candidates[key] = []; schedule.candidates[key].push(...otherCandidates); } } else { schedule.vacancies.push({ start: block.start, end: block.end }); } } for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { const dateStr = d.toISOString().slice(0, 10); if (dailySchedules.has(dateStr)) { await db.schedules.put(dailySchedules.get(dateStr)); } else { await db.schedules.put({ id: dateStr, shifts: {}, candidates: {}, vacancies: [] }); } } alert(`${year}年${month}月 ${period === 1 ? '前半' : '後半'} のシフトを生成しました。`); dom.scheduleYearSelect.value = year; dom.scheduleMonthSelect.value = month; dom.schedulePeriodSelect.value = period; await renderScheduleForPeriod(); } catch (error) { console.error("シフト生成中に致命的なエラーが発生しました:", error); alert("シフト生成中にエラーが発生しました。開発者コンソール(F12キー)で詳細を確認してください。"); } };
    
    // シフト表の表示
    const renderScheduleForPeriod = async () => { const year = parseInt(dom.scheduleYearSelect.value), month = parseInt(dom.scheduleMonthSelect.value), period = parseInt(dom.schedulePeriodSelect.value); const { startDay, endDay } = getDayRange(year, month, period); const dateList = []; for (let day = startDay; day <= endDay; day++) dateList.push(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`); const schedules = await db.schedules.bulkGet(dateList); const allEmployees = await db.employees.toArray(); const employeeMap = new Map(allEmployees.map(e => [e.id, e.name])); dom.scheduleTableContainer.innerHTML = ''; schedules.forEach((schedule, index) => { const date = dateList[index]; dom.scheduleTableContainer.innerHTML += `<h4>${new Date(date+'T00:00:00').toLocaleDateString('ja-JP', {month: 'long', day: 'numeric', weekday: 'short'})}</h4>`; if (schedule) { const timelineContainer = document.createElement('div'); timelineContainer.innerHTML = renderTimelineForDate(schedule, allEmployees, employeeMap, date); dom.scheduleTableContainer.appendChild(timelineContainer); initializeSortableForDate(date); } else { dom.scheduleTableContainer.innerHTML += `<p style="padding:10px; background:#fff3cd;">この日のシフトは作成されていません。</p>`; } }); };
    const renderTimelineForDate = (schedule, allEmployees, employeeMap, date) => { let timelineHTML = `<div class="schedule-timeline-container" id="timeline-container-${date}"><div class="schedule-timeline">`; const totalMinutes = 24 * 60; let headerHTML = `<div class="timeline-header"><div class="timeline-label"></div><div class="timeline-slots"><div class="timeline-grid">${Array.from({length: 24}).map((_, i) => `<div class="grid-line"><div class="time-marker">${i}:00</div></div>`).join('')}</div></div></div>`; let vacancyRowHTML = ''; if (schedule.vacancies && schedule.vacancies.length > 0) { let vacancyBarsHTML = ''; const vacancyGroups = schedule.vacancies.reduce((acc, v) => { const key = `${v.start}-${v.end}`; acc[key] = (acc[key] || 0) + 1; return acc; }, {}); for(const timeRange in vacancyGroups) { const count = vacancyGroups[timeRange]; const [startStr, endStr] = timeRange.split('-'); const start = timeToMinutes(startStr), end = timeToMinutes(endStr); const left = (start / totalMinutes) * 100, width = ((end - start) / totalMinutes) * 100; vacancyBarsHTML += `<div class="vacancy-bar" style="left: ${left}%; width: ${width}%;" title="${startStr}-${endStr} ${count}人不足">不足: ${count}人</div>`; } vacancyRowHTML = `<div class="timeline-row"><div class="timeline-label" style="color: #dc3545; font-weight: bold;">欠員</div><div class="timeline-slots">${vacancyBarsHTML}</div></div>`; } let employeeRowsHTML = ''; allEmployees.forEach(emp => { let barsHTML = ''; if (schedule.shifts && schedule.shifts[emp.id]) { const typeClass = emp.type === 'part-time' ? 'part-time' : 'casual'; schedule.shifts[emp.id].forEach((shift, index) => { const start = timeToMinutes(shift.start), end = timeToMinutes(shift.end); const left = (start / totalMinutes) * 100, width = ((end - start) / totalMinutes) * 100; barsHTML += `<div class="employee-bar ${typeClass}" data-shift-id="${emp.id}-${index}" data-start="${shift.start}" data-end="${shift.end}" style="left: ${left}%; width: ${width}%;" title="${employeeMap.get(emp.id)}: ${shift.start}-${shift.end}">${shift.start}</div>`; }); } if (schedule.candidates) { for (const timeRange in schedule.candidates) { if (schedule.candidates[timeRange].includes(emp.id)) { const [startStr, endStr] = timeRange.split('-'); const start = timeToMinutes(startStr), end = timeToMinutes(endStr); const left = (start / totalMinutes) * 100, width = ((end - start) / totalMinutes) * 100; barsHTML += `<div class="candidate-bar" data-action="swap-shift" data-date="${date}" data-start="${startStr}" data-end="${endStr}" data-candidate-id="${emp.id}" style="left: ${left}%; width: ${width}%;" title="クリックして交代"></div>`; } } } employeeRowsHTML += `<div class="timeline-row"><div class="timeline-label">${employeeMap.get(emp.id)}</div><div class="timeline-slots" data-date="${date}" data-employee-id="${emp.id}">${barsHTML}</div></div>`; }); timelineHTML += headerHTML + vacancyRowHTML + employeeRowsHTML + '</div></div>'; return timelineHTML; };
    const initializeSortableForDate = (date) => { const container = document.getElementById(`timeline-container-${date}`); if (!container) return; const slotElements = container.querySelectorAll('.timeline-slots'); slotElements.forEach(slot => { new Sortable(slot, { group: `shared-${date}`, animation: 150, ghostClass: 'sortable-ghost', onEnd: async (evt) => { const fromEmployeeId = parseInt(evt.from.dataset.employeeId, 10), toEmployeeId = parseInt(evt.to.dataset.employeeId, 10); if (fromEmployeeId === toEmployeeId) return; const shiftElement = evt.item; const shiftStart = shiftElement.dataset.start, shiftEnd = shiftElement.dataset.end; try { await db.transaction('rw', db.schedules, async () => { const schedule = await db.schedules.get(date); if (!schedule) throw new Error("Schedule not found"); const fromShifts = schedule.shifts[fromEmployeeId] || []; const shiftIndex = fromShifts.findIndex(s => s.start === shiftStart && s.end === shiftEnd); if (shiftIndex > -1) { const [swappedShift] = fromShifts.splice(shiftIndex, 1); if (!schedule.shifts[toEmployeeId]) schedule.shifts[toEmployeeId] = []; schedule.shifts[toEmployeeId].push(swappedShift); if (schedule.candidates) { const key = `${swappedShift.start}-${swappedShift.end}`; if (schedule.candidates[key]) { const idx = schedule.candidates[key].indexOf(toEmployeeId); if (idx > -1) schedule.candidates[key].splice(idx, 1); schedule.candidates[key].push(fromEmployeeId); } } } await db.schedules.put(schedule); }); await renderScheduleForPeriod(); alert('シフトを更新しました。'); } catch (error) { console.error('Shift update failed:', error); alert('シフトの更新に失敗しました。ページをリロードしてください。'); } } }); }); };
    const handleCandidateClick = async (target) => { const { date, start, end, candidateId } = target.dataset; const newEmployeeId = parseInt(candidateId, 10); if (!date || !start || !end || !newEmployeeId) return; if (!confirm(`${date} の ${start}～${end} のシフトを交代しますか？`)) return; try { await db.transaction('rw', db.schedules, async () => { const schedule = await db.schedules.get(date); if (!schedule) throw new Error("Schedule not found"); let currentEmployeeId = null, shiftIndex = -1; for (const empId in schedule.shifts) { const i = schedule.shifts[empId].findIndex(s => s.start === start && s.end === end); if (i > -1) { currentEmployeeId = parseInt(empId, 10); shiftIndex = i; break; } } if (currentEmployeeId === null) { throw new Error("元の担当者が見つかりません。"); } const [swappedShift] = schedule.shifts[currentEmployeeId].splice(shiftIndex, 1); if (schedule.shifts[currentEmployeeId].length === 0) delete schedule.shifts[currentEmployeeId]; if (!schedule.shifts[newEmployeeId]) schedule.shifts[newEmployeeId] = []; schedule.shifts[newEmployeeId].push(swappedShift); const candidateKey = `${start}-${end}`; if (schedule.candidates && schedule.candidates[candidateKey]) { const idx = schedule.candidates[candidateKey].indexOf(newEmployeeId); if (idx > -1) schedule.candidates[candidateKey].splice(idx, 1); schedule.candidates[candidateKey].push(currentEmployeeId); } await db.schedules.put(schedule); }); await renderScheduleForPeriod(); alert('シフトを交代しました。'); } catch (error) { console.error('Shift swap failed:', error); alert('シフトの交代に失敗しました。'); } };
    
    // 初期化処理
    populateTimeSelects();
    populateYearMonthSelects();
    showView('modeSelection');

    // イベントリスナー
    dom.adminModeBtn.addEventListener('click', setupAdminMode);
    dom.employeeModeBtn.addEventListener('click', showEmployeeSelection);
    dom.selectEmployeeBtn.addEventListener('click', () => { const selectedId = parseInt(dom.employeeSelector.value, 10); if (selectedId) setupEmployeeMode(selectedId); });
    dom.employeeSelector.addEventListener('change', () => dom.selectEmployeeBtn.disabled = !dom.employeeSelector.value);
    dom.backButtons.forEach(btn => btn.addEventListener('click', showModeSelectionView));
    dom.demandDateInput.addEventListener('change', () => renderDemandsForDate(dom.demandDateInput.value));
    dom.demandForm.addEventListener('submit', addDemand);
    dom.openDemandCopyModalBtn.addEventListener('click', openDemandCopyModal);
    dom.executeDemandCopyBtn.addEventListener('click', executeDemandCopy);
    dom.employeeForm.addEventListener('submit', addEmployee);
    dom.availabilityForm.addEventListener('submit', addAvailability);
    dom.generationForm.addEventListener('submit', handleGenerateSchedule);
    dom.scheduleSelectorContainer.addEventListener('change', renderScheduleForPeriod);
    dom.openCopyModalBtn.addEventListener('click', openAvailabilityCopyModal);
    dom.executeCopyBtn.addEventListener('click', executeCopy);
    dom.copyModal.querySelector('.close-btn').addEventListener('click', () => closeCopyModal('availability'));
    dom.demandCopyModal.querySelector('.close-btn').addEventListener('click', () => closeCopyModal('demand'));
    window.addEventListener('click', (event) => { if (event.target == dom.copyModal) closeCopyModal('availability'); if (event.target == dom.demandCopyModal) closeCopyModal('demand'); });
    dom.scheduleTableContainer.addEventListener('click', (event) => { if (event.target.dataset.action === 'swap-shift') handleCandidateClick(event.target); });
});
</script>
</body>
</html>